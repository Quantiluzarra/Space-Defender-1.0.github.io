<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Космический Защитник</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            user-select: none; 
            touch-action: none; 
        }
        body { 
            background: #1a1a2e; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
            touch-action: none;
        }
        canvas { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            touch-action: none;
        }
        #gameOverScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        #restartButton {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 22px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="gameOverScreen">
        <h1>Игра окончена!</h1>
        <p id="finalScore">Ваш счет: 0</p>
        <button id="restartButton">Начать заново</button>
    </div>

    <script>
        class SpaceDefender {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gameOverScreen = document.getElementById('gameOverScreen');
                this.finalScoreElement = document.getElementById('finalScore');
                this.restartButton = document.getElementById('restartButton');
                
                this.setupCanvas();
                this.initGame();
                this.setupEventListeners();
            }

            setupCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                                });
            }

            setupEventListeners() {
                this.restartButton.addEventListener('click', () => this.restartGame());

                // Добавляем управление для мобильных устройств
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault(); // Отключаем скролл
                    const touch = e.touches[0];
                    // Ограничиваем движение в пределах экрана
                    this.player.x = Math.max(0, Math.min(
                        touch.clientX - this.player.width / 2, 
                        this.canvas.width - this.player.width
                    ));
                }, { passive: false });
            }

            restartGame() {
                this.gameOverScreen.style.display = 'none';
                this.initGame();
            }

            initGame() {
                // Уменьшаем размер для мобильных
                const scaleFactor = this.canvas.width / 500;
                
                this.player = {
                    x: this.canvas.width / 2,
                    y: this.canvas.height - 100 * scaleFactor,
                    width: 50 * scaleFactor,
                    height: 50 * scaleFactor,
                    speed: 5 * scaleFactor,
                    autoShoot: true // Включаем автострельбу по умолчанию
                };

                this.enemies = [];
                this.bullets = [];
                this.score = 0;
                this.gameOver = false;
                this.lastShootTime = 0;
                this.lastEnemySpawnTime = 0;

                this.startGameLoop();
            }

            shootBullet() {
                const currentTime = Date.now();
                // Уменьшаем интервал между выстрелами
                if (currentTime - this.lastShootTime > 100) {
                    this.bullets.push({
                        x: this.player.x + this.player.width / 2,
                        y: this.player.y,
                        width: 5 * (this.canvas.width / 500),
                        height: 15 * (this.canvas.width / 500),
                        speed: 10 * (this.canvas.width / 500)
                    });
                    this.lastShootTime = currentTime;
                }
            }

            spawnEnemies() {
                const currentTime = Date.now();
                // Увеличиваем частоту появления врагов
                if (currentTime - this.lastEnemySpawnTime > 500) {
                    const scaleFactor = this.canvas.width / 500;
                    this.enemies.push({
                        x: Math.random() * (this.canvas.width - 50 * scaleFactor),
                        y: -50 * scaleFactor,
                        width: 50 * scaleFactor,
                        height: 50 * scaleFactor,
                        speed: (Math.random() * 3 + 1) * scaleFactor
                    });
                    this.lastEnemySpawnTime = currentTime;
                }
            }

            updateGameObjects() {
                // Автоматическая стрельба
                this.shootBullet();

                // Обновление врагов
                this.enemies.forEach((enemy, index) => {
                    enemy.y += enemy.speed;
                    
                    // Проверка столкновения с игроком
                    if (this.checkCollision(this.player, enemy)) {
                        this.gameOver = true;
                    }

                    if (enemy.y > this.canvas.height) {
                        this.enemies.splice(index, 1);
                    }
                });

                // Обновление пуль
                this.bullets.forEach((bullet, bIndex) => {
                    bullet.y -= bullet.speed;
                    
                    // Проверка столкновения пуль с врагами
                    this.enemies.forEach((enemy, eIndex) => {
                        if (this.checkCollision(bullet, enemy)) {
                            this.bullets.splice(bIndex, 1);
                            this.enemies.splice(eIndex, 1);
                            this.score++;
                        }
                    });

                    if (bullet.y < 0) this.bullets.splice(bIndex, 1);
                });
            }

            checkCollision(rect1, rect2) {
                return !(rect1.x > rect2.x + rect2.width ||
                         rect1.x + rect1.width < rect2.x ||
                         rect1.y > rect2.y + rect2.height ||
                         rect1.y + rect1.height < rect2.y);
            }

            drawGameObjects() {
                // Очистка с учетом размера экрана
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Рисование игрока
                this.ctx.fillStyle = 'blue';
                this.ctx.fillRect(
                    this.player.x, 
                    this.player.y, 
                    this.player.width, 
                    this.player.height
                );

                // Рисование врагов
                this.ctx.fillStyle = 'red';
                this.enemies.forEach(enemy => {
                    this.ctx.fillRect(
                        enemy.x, 
                        enemy.y, 
                        enemy.width, 
                        enemy.height
                    );
                });

                // Рисование пуль
                this.ctx.fillStyle = 'yellow';
                this.bullets.forEach(bullet => {
                    this.ctx.fillRect(
                        bullet.x, 
                        bullet.y, 
                        bullet.width, 
                        bullet.height
                    );
                });

                // Отображение счета с адаптивным размером шрифта
                this.ctx.fillStyle = 'white';
                this.ctx.font = `${24 * (this.canvas.width / 500)}px Arial`;
                this.ctx.fillText(`Счет: ${this.score}`, 20, 50);
            }

            startGameLoop() {
                const gameLoop = () => {
                    if (!this.gameOver) {
                        this.spawnEnemies();
                        this.updateGameObjects();
                        this.drawGameObjects();
                        requestAnimationFrame(gameLoop);
                    } else {
                        this.finalScoreElement.textContent = `Ваш счет: ${this.score}`;
                        this.gameOverScreen.style.display = 'flex';
                    }
                };
                gameLoop();
            }
        }

        // Инициализация игры
        new SpaceDefender();
    </script>
</body>
</html>
